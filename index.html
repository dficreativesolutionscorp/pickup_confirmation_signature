<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>DFI Rentals - Pickup Confirmation</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=Roboto:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /*
         * DFI Rentals Design System
         * Matching the website's design language
         */
        :root {
            --color-primary: #000000;
            --color-surface: #ffffff;
            --color-background: #f5f5f5;
            --color-success: #7DD654;
            --color-destructive: #ED3E44;
            --color-alert: #DCDBDD;
            --color-text-primary: #121212;
            --color-text-secondary: #646464;
            --color-border: #e0e0e0;
            --font-primary: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-secondary: 'Roboto', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            line-height: 1.6;
            color: var(--color-text-primary);
            background-color: var(--color-background);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .header {
            background-color: var(--color-primary);
            color: var(--color-surface);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo {
            height: 40px;
            width: auto;
        }

        .container {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background-color: var(--color-surface);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .content {
            padding: 30px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
        }

        h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 25px 0 15px 0;
        }

        /* Order Entry Screen */
        .order-entry {
            text-align: center;
            padding: 60px 20px;
        }

        .order-entry h2 {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            max-width: 400px;
            margin: 0 auto 20px;
            gap: 10px;
        }

        input[type="text"], input[type="number"], input[type="password"] {
            flex: 1;
            padding: 12px 20px;
            font-size: 16px;
            border: 1px solid var(--color-border);
            border-radius: 0;
            font-family: var(--font-primary);
            -webkit-appearance: none;
        }

        input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        input:disabled {
            background-color: #f8f8f8;
            color: #999;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 500;
            background-color: var(--color-primary);
            color: var(--color-surface);
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
            font-family: var(--font-primary);
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: var(--color-surface);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        /* Order Info Section */
        .order-info {
            background-color: var(--color-surface);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            border: 1px solid var(--color-border);
        }

        .info-card {
            border-left: 3px solid var(--color-primary);
            padding-left: 15px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            color: var(--color-text-primary);
        }

        .coupon-badge {
            display: inline-block;
            background-color: var(--color-success);
            color: white;
            padding: 2px 8px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Line Items */
        .items-container {
            border: 1px solid var(--color-border);
            padding: 10px;
            margin-bottom: 20px;
        }

        .line-item {
            border-bottom: 1px solid #eee;
            padding: 12px 0;
            display: flex;
            align-items: center;
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item.bundle {
            font-weight: 600;
            background-color: #f8f8f8;
            margin: 10px -10px;
            padding: 12px 10px;
        }

        .line-item.child {
            margin-left: 40px;
            font-size: 0.95em;
        }

        .line-item.section {
            background-color: #f0f0f0;
            font-weight: 600;
            justify-content: center;
            text-transform: uppercase;
            font-size: 0.9em;
            color: #666;
            margin: 20px -10px 10px;
            padding: 10px;
        }

        .item-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .item-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 15px;
            border: 1px solid #ddd;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .item-quantity {
            color: #666;
            font-size: 0.9em;
        }

        .item-price {
            text-align: right;
            font-weight: 500;
        }

        /* Totals */
        .totals {
            padding: 20px 0;
            margin: 30px 0;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 0 10px;
        }

        .total-row:last-child {
            margin-bottom: 0;
        }

        .total-row.grand-total {
            font-weight: 700;
            font-size: 1.1em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .total-row.deposit {
            color: #666;
            font-size: 0.95em;
        }

        .total-row.discount {
            color: var(--color-success);
        }

        /* Signature Section */
        .signature-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .signature-section.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .signature-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .signature-warning::before {
            content: "⚠️";
            font-size: 1.2em;
        }

        .terms-checkbox {
            display: block;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 5px 0;
        }

        .terms-checkbox input {
            margin-right: 8px;
        }


        /* Email Preference Section */
.email-preference-section {
    background-color: #f0f4f8;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid var(--color-border);
    border-radius: 4px;
}

.email-preference-section h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
}

.email-option {
    margin-bottom: 15px;
}

.email-option label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 15px;
}

.email-option input[type="radio"] {
    margin-right: 10px;
}

.email-display {
    font-weight: 600;
    color: var(--color-primary);
    margin-left: 5px;
}

.custom-email-input {
    margin-top: 10px;
    margin-left: 30px;
    display: none;
}

.custom-email-input input {
    width: 300px;
    max-width: 100%;
}

        canvas {
            border: 2px solid #ddd;
            display: block;
            margin: 10px auto;
            cursor: crosshair;
            background-color: white;
            touch-action: none;
        }

        .signature-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* Lock Screen */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-primary);
            color: var(--color-surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            z-index: 1000;
        }

        .lock-screen h1 {
            color: var(--color-surface);
            font-size: 32px;
            margin-bottom: 20px;
        }

        .lock-screen p {
            font-size: 18px;
            margin-bottom: 40px;
        }

        .slide-unlock {
            width: 300px;
            height: 60px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .slide-track {
            position: absolute;
            left: 5px;
            top: 5px;
            width: 50px;
            height: 50px;
            background-color: var(--color-surface);
            border-radius: 25px;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide-track::after {
            content: "→";
            color: var(--color-primary);
            font-size: 24px;
        }

        .slide-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 60px;
            font-size: 16px;
            pointer-events: none;
        }

        .passcode-input {
            margin-top: 20px;
        }

        .passcode-input input {
            background-color: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--color-surface);
            text-align: center;
            font-size: 24px;
            letter-spacing: 10px;
            width: 200px;
        }

        .passcode-input input::placeholder {
            color: rgba(255,255,255,0.5);
            letter-spacing: normal;
        }







        /* Refresh Button */
        .refresh-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--color-surface);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: none;
        }

        .refresh-button:hover {
            background-color: var(--color-primary);
            color: var(--color-surface);
        }

        .refresh-button.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--color-surface);
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--color-destructive);
        }

        .modal-content p {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-buttons button {
            min-width: 120px;
        }

        /* Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Utilities */
        .error {
            color: var(--color-destructive);
            text-align: center;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 60px;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .content {
                padding: 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }

            .order-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="https://96da7cca2c986bf3ad2018ee4004e4c7.cdn.bubble.io/f1718641957034x160202349751742620/DFI%2BRentals%2BLogo%2BInverse.png" alt="DFI Rentals" class="logo">
        <div id="currentDateTime" style="font-size: 14px;"></div>
        <button id="refreshButton" class="refresh-button" onclick="refreshOrder()">↻ Refresh</button>
    </div>

    <div class="container">
        <!-- Order Entry Section -->
        <div id="orderEntry" class="content">
            <div class="order-entry">
                <h2>Enter Order Number</h2>
                <div class="input-group">
                    <input type="text" id="orderNumber" placeholder="Order Number" autofocus>
                    <button onclick="fetchOrder()">Get Order</button>
                </div>
                <div id="errorMessage" class="error"></div>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Loading order details...</p>
        </div>

        <!-- Order Details Section -->
        <div id="orderDetails" class="content hidden">
            <!-- Order will be populated here -->
        </div>
    </div>

   <!-- Modal -->
    <div id="warningModal" class="modal">
        <div class="modal-content">
            <h3>⚠️ Important Warning</h3>
            <p>Are you sure you have checked all the items on your order?</p>
            <p><strong>By checking this box, you are taking full responsibility for all items, including any loss and damage from this point forward, and you confirm there is no pre-existing damage.</strong></p>
            <div class="modal-buttons">
                <button class="button-secondary" onclick="closeModal()">Cancel</button>
                <button onclick="confirmLiability()">I Understand</button>
            </div>
        </div>
    </div>

    <!-- Lock Screen -->
    <div id="lockScreen" class="lock-screen hidden">
        <h1>✓ Pickup Complete</h1>
        <p>Return Tablet to Rental Associate</p>
        
        <div id="slideToUnlock" class="slide-unlock">
            <div class="slide-track" id="slideTrack"></div>
            <div class="slide-text">Slide to Unlock</div>
        </div>
        
        <div id="passcodeSection" class="passcode-input hidden">
            <input type="password" id="passcode" placeholder="Enter Code" maxlength="4">
            <div id="passcodeError" class="error" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        /*
         * DFI Rentals Pickup Confirmation App
         * Handles order fetching, signature capture, and API integration
         */
        
        const API_KEY = '47c4f6c39f9666034face985d225a522b60c3ae8fd923fae6af9bca907e2caf5';
        const API_BASE = 'https://dfi-rentals.booqable.com/api/4';
        
        let currentOrder = null;
        let currentOrderId = null;
        let currentDocumentId = null;
        let checkedItems = new Set();
        let isDrawing = false;
        let signatureData = null;
        let pendingLiabilityCheck = false;

        // Update date/time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        /*
         * Fetches order data from Booqable API
         */
        async function fetchOrder() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            
            if (!orderNumber) {
                showError('Please enter an order number');
                return;
            }
            
            showError('');
            document.getElementById('orderEntry').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const response = await fetch(`https://dfi-rentals.booqable.com/api/1/orders/${orderNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                
                const data = await response.json();
                currentOrder = data.order;
                currentOrderId = data.order.id;
                displayOrder();
                
            } catch (error) {
                showError(error.message);
                document.getElementById('orderEntry').classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        /*
         * Displays the order details with improved grid layout
         */
        function displayOrder() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('orderDetails').classList.remove('hidden');
            
            const orderDetails = document.getElementById('orderDetails');
            orderDetails.innerHTML = `
                <h1 style="text-align: center; margin-bottom: 30px;">Pickup Confirmation #${currentOrder.number}</h1>
                
                <!-- Customer Info Grid -->
                <div class="order-info">
                    <div class="info-card">
                        <div class="info-label">Order Number</div>
                        <div class="info-value">#${currentOrder.number}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Today's Date</div>
                        <div class="info-value">${formatDate(new Date())}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Customer</div>
                        <div class="info-value">${currentOrder.customer?.name || currentOrder.customer_name || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Email</div>
                        <div class="info-value">${currentOrder.customer?.email || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Pickup Date</div>
                        <div class="info-value">${formatDateTime(currentOrder.starts_at)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Return Date</div>
                        <div class="info-value">${formatDateTime(currentOrder.stops_at)}</div>
                    </div>
                    ${currentOrder.coupon_code ? `
                    <div class="info-card">
                        <div class="info-label">Coupon Applied</div>
                        <div class="info-value">
                            ${currentOrder.coupon_code}
                            <span class="coupon-badge">${currentOrder.coupon_percentage || 0}% OFF</span>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Line Items -->
                <h2>Order Items</h2>
                <div class="items-container" id="lineItems"></div>

                <!-- Totals -->
                <div class="totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(currentOrder.price_in_cents)}</span>
                    </div>
                    ${currentOrder.total_discount_in_cents > 0 ? `
                        <div class="total-row discount">
                            <span>Discount${currentOrder.coupon_code ? ' (' + currentOrder.coupon_code + ')' : ''}:</span>
                            <span>-${formatCurrency(currentOrder.total_discount_in_cents)}</span>
                        </div>
                        <div class="total-row">
                            <span>Subtotal after discount:</span>
                            <span>${formatCurrency(currentOrder.price_in_cents - currentOrder.total_discount_in_cents)}</span>
                        </div>
                    ` : ''}
                    ${currentOrder.tax_in_cents > 0 ? `
                        <div class="total-row">
                            <span>Tax:</span>
                            <span>${formatCurrency(currentOrder.tax_in_cents)}</span>
                        </div>
                    ` : ''}
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span>${formatCurrency(currentOrder.grand_total_in_cents)}</span>
                    </div>
                    <div class="total-row deposit">
                        <span>Estimated Replacement Value/Insurance Value:</span>
                        <span>${formatCurrency(currentOrder.deposit_in_cents)}</span>
                    </div>
                </div>

                <!-- Signature Section -->
                <div id="signatureSection" class="signature-section">
                    <h2>Terms & Conditions</h2>
                    <div id="itemCheckWarning" class="signature-warning hidden">
                        Please check all items in the list above before proceeding with the signature.
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label class="terms-checkbox">
                            <input type="checkbox" id="confirmAllPresent" onchange="updateConfirmButton()">
                            I confirm that I have received all of the equipment listed above and verified that the equipment matches the description provided.
                        </label>
                        <label class="terms-checkbox">
                            <input type="checkbox" id="confirmGoodCondition" onchange="updateConfirmButton()">
                            I confirm that all items are in good working condition, free from any damages, physical or functional, unless otherwise indicated.
                        </label>
                        <label class="terms-checkbox">
                            <input type="checkbox" id="acceptTerms" onchange="updateConfirmButton()">
                            I accept and agree to be bound by all terms and conditions of the DFI Rental Agreement, which can be found at <a href="https://www.dfirentals.com/rentalagreement" target="_blank">https://www.dfirentals.com/rentalagreement</a>
                        </label>
                        <label class="terms-checkbox">
                            <input type="checkbox" id="authorizedAgent" onchange="updateConfirmButton()">
                            I warrant that I am either the customer listed above OR an authorized agent of the customer listed above.
                        </label>
                        <label class="terms-checkbox">
                            <input type="checkbox" id="acceptLiability" onchange="handleLiabilityCheck()">
                            I understand that by signing here, I am taking responsibility and liability for these items, including any loss or damage.
                        </label>
                    </div>

                    <!-- Email Preference Section -->
<div class="email-preference-section">
    <h3>How would you like to receive your pickup confirmation?</h3>
    <div class="email-option">
        <label>
            <input type="radio" name="emailOption" value="onFile" checked onchange="toggleCustomEmail()">
            Send to email on file: <span class="email-display">${currentOrder.customer?.email || 'N/A'}</span>
        </label>
    </div>
    <div class="email-option">
        <label>
            <input type="radio" name="emailOption" value="custom" onchange="toggleCustomEmail()">
            Send to a different email
        </label>
        <div class="custom-email-input" id="customEmailSection">
            <input type="email" id="customEmail" placeholder="Enter email address" onkeyup="updateConfirmButton()">
        </div>
    </div>
</div>
                    
                    <h2>Signature</h2>
                    <div style="margin-bottom: 15px;">
                        <label for="signerName">Signed by:</label>
                        <input type="text" id="signerName" placeholder="Enter your name" style="margin-left: 10px; width: 300px;" onkeyup="updateConfirmButton()">
                    </div>
                    <p>Please sign below to confirm pickup:</p>
                    <canvas id="signatureCanvas" width="400" height="150"></canvas>
                    <div class="signature-buttons">
                        <button class="button-secondary" onclick="clearSignature()">Clear</button>
                        <button id="confirmButton" onclick="confirmPickup()" disabled>Confirm Pickup</button>
                    </div>
                </div>
            `;
            
            displayLineItems();
            initializeSignaturePad();
            updateSignatureSection();
            
            // Show refresh button
            document.getElementById('refreshButton').style.display = 'block';
        }

        /*
         * Displays line items with proper organization and section handling
         */
        function displayLineItems() {
            const container = document.getElementById('lineItems');
            container.innerHTML = '';
            
            if (!currentOrder.lines || currentOrder.lines.length === 0) {
                container.innerHTML = '<p>No items found</p>';
                return;
            }
            
            // Sort lines by sorting_position
            const sortedLines = [...currentOrder.lines].sort((a, b) => a.sorting_position - b.sorting_position);
            
            // Group lines by parent
            const linesByParent = {};
            const topLevelLines = [];
            
            sortedLines.forEach(line => {
                if (line.parent_line_id) {
                    if (!linesByParent[line.parent_line_id]) {
                        linesByParent[line.parent_line_id] = [];
                    }
                    linesByParent[line.parent_line_id].push(line);
                } else {
                    topLevelLines.push(line);
                }
            });
            
            // Render lines
            topLevelLines.forEach(line => {
                renderLine(line, container, false);
                
                // Render child lines if this is a bundle
                if (linesByParent[line.id]) {
                    linesByParent[line.id].forEach(childLine => {
                        renderLine(childLine, container, true);
                    });
                }
            });
        }

        /*
         * Renders a single line item with proper section detection
         */
        function renderLine(line, container, isChild) {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-item';
            
            if (isChild) {
                lineDiv.className += ' child';
            }
            
            // Handle section lines
            if (line.line_type === 'section') {
                lineDiv.className += ' section';
                lineDiv.innerHTML = `<div class="item-name">${line.title}</div>`;
                container.appendChild(lineDiv);
                return;
            }
            
            // Handle bundle lines
            const isBundle = !line.parent_line_id && hasChildren(line.id);
            if (isBundle) {
                lineDiv.className += ' bundle';
            }
            
            let html = '';
            
            // Only add checkbox for actual items (not bundles or sections)
            if (!isBundle && line.line_type !== 'section') {
                html += `<input type="checkbox" class="item-checkbox" data-line-id="${line.id}" onchange="toggleItem('${line.id}')">`;
            }
            
            // Add product image if available
            if (line.product_photo_url) {
                html += `<img src="${line.product_photo_url}" alt="${line.title}" class="item-image">`;
            }
            
            html += `
    <div class="item-details">
        <div class="item-name">${line.title || 'Unknown Item'}</div>
        <div class="item-quantity">Quantity: ${line.quantity}</div>
        ${line.extra_information ? `
            <div class="item-extra-info" style="margin-top: 8px; font-size: 0.85em; color: #666; line-height: 1.4; white-space: pre-wrap;">${line.extra_information}</div>
        ` : ''}
    </div>
    <div class="item-price">${formatCurrency(line.price_in_cents)}</div>
`;
            
            lineDiv.innerHTML = html;
            container.appendChild(lineDiv);
        }

        /*
         * Checks if a line has children
         */
        function hasChildren(lineId) {
            return currentOrder.lines.some(line => line.parent_line_id === lineId);
        }

        /*
         * Handles item checkbox toggle
         */
        function toggleItem(lineId) {
            const checkbox = document.querySelector(`[data-line-id="${lineId}"]`);
            
            if (checkbox.checked) {
                checkedItems.add(lineId);
            } else {
                checkedItems.delete(lineId);
            }
            
            updateConfirmButton();
            updateSignatureSection();
        }

        /*
         * Updates signature section based on checklist
         */
        function updateSignatureSection() {
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const allChecked = allCheckboxes.length > 0 && 
                              allCheckboxes.length === checkedItems.size;
            
            const signatureSection = document.getElementById('signatureSection');
            const warningDiv = document.getElementById('itemCheckWarning');
            
            if (allChecked) {
                signatureSection.classList.remove('disabled');
                warningDiv.classList.add('hidden');
            } else {
                signatureSection.classList.add('disabled');
                warningDiv.classList.remove('hidden');
            }
        }

        /*
         * Initialize signature canvas
         */
        function initializeSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';
                
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    updateConfirmButton();
                }
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        /*
         * Clear signature
         */
        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updateConfirmButton();
        }

        /*
         * Check if canvas is empty
         */
        function isCanvasEmpty() {
            const canvas = document.getElementById('signatureCanvas');
            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            return canvas.toDataURL() === blank.toDataURL();
        }

        /*
 * Validate email format
 */
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

        /*
         * Update confirm button state
         */
        function updateConfirmButton() {
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const allChecked = allCheckboxes.length > 0 && 
                              allCheckboxes.length === checkedItems.size;
            
            const hasSignature = !isCanvasEmpty();
            const signerName = document.getElementById('signerName').value.trim();
            
            const termsAccepted = 
                document.getElementById('confirmAllPresent').checked &&
                document.getElementById('confirmGoodCondition').checked &&
                document.getElementById('acceptTerms').checked &&
                document.getElementById('authorizedAgent').checked &&
                document.getElementById('acceptLiability').checked;
            
                const emailOption = document.querySelector('input[name="emailOption"]:checked').value;
const customEmail = document.getElementById('customEmail').value.trim();
const emailValid = emailOption === 'onFile' || 
                  (emailOption === 'custom' && customEmail && isValidEmail(customEmail));

document.getElementById('confirmButton').disabled = 
    !(allChecked && hasSignature && signerName && termsAccepted && emailValid);
        }

        /*
 * Toggle custom email input visibility
 */
function toggleCustomEmail() {
    const emailOption = document.querySelector('input[name="emailOption"]:checked').value;
    const customEmailSection = document.getElementById('customEmailSection');
    const customEmailInput = document.getElementById('customEmail');
    
    if (emailOption === 'custom') {
        customEmailSection.style.display = 'block';
        customEmailInput.required = true;
    } else {
        customEmailSection.style.display = 'none';
        customEmailInput.required = false;
        customEmailInput.value = '';
    }
    
    updateConfirmButton();
}

        /*
         * Confirm pickup and send to API
         */
        async function confirmPickup() {
            const canvas = document.getElementById('signatureCanvas');
            signatureData = canvas.toDataURL('image/png');
            const signerName = document.getElementById('signerName').value.trim();
            
            try {
                // Step 1: Generate contract document
                const docResponse = await fetch(`${API_BASE}/documents/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: {
                            type: 'documents',
                            attributes: {
                                document_type: 'contract',
                                order_id: currentOrderId
                            }
                        }
                    })
                });
                
                if (!docResponse.ok) throw new Error('Failed to generate contract');
                
                const docData = await docResponse.json();
                currentDocumentId = docData.data.id;
                
                // Step 2: Update document footer with signer name and timestamp
                const now = new Date();
                const timestamp = formatDateTime(now.toISOString());
                const updateResponse = await fetch(`${API_BASE}/documents/${currentDocumentId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: {
                            id: currentDocumentId,
                            type: 'documents',
                            attributes: {
                                footer: `Signed By: ${signerName} | Signed At: ${timestamp}`
                            }
                        }
                    })
                });
                
                if (!updateResponse.ok) throw new Error('Failed to update document');
                
                // Step 3: Attach signature
                const signResponse = await fetch(`${API_BASE}/signatures/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: {
                            type: 'signatures',
                            attributes: {
                                document_id: currentDocumentId,
                                signature_base64: signatureData
                            }
                        }
                    })
                });
                
                if (!signResponse.ok) throw new Error('Failed to save signature');

// Step 4: Send email confirmation
const emailOption = document.querySelector('input[name="emailOption"]:checked').value;
const recipientEmail = emailOption === 'onFile' 
    ? currentOrder.customer?.email 
    : document.getElementById('customEmail').value.trim();

const emailResponse = await fetch(`${API_BASE}/emails/`, {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        data: {
            type: 'emails',
            attributes: {
                recipients: recipientEmail,
                email_template_id: '977ff0cc-0fbd-432d-a1b3-effe01d94fab',
                order_id: currentOrderId,
                document_ids: [currentDocumentId]
            }
        }
    })
});

if (!emailResponse.ok) {
    console.error('Failed to send email, but pickup was confirmed');
}

// Show lock screen
showLockScreen();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        /*
         * Show lock screen after successful pickup
         */
        function showLockScreen() {
            document.getElementById('lockScreen').classList.remove('hidden');
            setupSlideToUnlock();
        }

        /*
         * Setup slide to unlock functionality
         */
        function setupSlideToUnlock() {
            const slideTrack = document.getElementById('slideTrack');
            const slideContainer = document.getElementById('slideToUnlock');
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            
            function handleStart(e) {
                isDragging = true;
                startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                currentX = startX;
            }
            
            function handleMove(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const deltaX = currentX - startX;
                const maxDelta = slideContainer.offsetWidth - slideTrack.offsetWidth - 10;
                
                if (deltaX >= 0 && deltaX <= maxDelta) {
                    slideTrack.style.transform = `translateX(${deltaX}px)`;
                }
                
                if (deltaX >= maxDelta * 0.9) {
                    handleUnlock();
                }
            }
            
            function handleEnd() {
                if (!isDragging) return;
                isDragging = false;
                
                slideTrack.style.transform = 'translateX(0)';
            }
            
            function handleUnlock() {
                isDragging = false;
                document.getElementById('slideToUnlock').classList.add('hidden');
                document.getElementById('passcodeSection').classList.remove('hidden');
                document.getElementById('passcode').focus();
            }
            
            // Mouse events
            slideTrack.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            
            // Touch events
            slideTrack.addEventListener('touchstart', handleStart);
            document.addEventListener('touchmove', handleMove);
            document.addEventListener('touchend', handleEnd);
        }

        /*
         * Handle passcode entry
         */
        document.addEventListener('DOMContentLoaded', function() {
            const passcodeInput = document.getElementById('passcode');
            if (passcodeInput) {
                passcodeInput.addEventListener('keyup', function(e) {
                    if (this.value === '1080') {
                        resetApp();
                    } else if (this.value.length === 4) {
                        document.getElementById('passcodeError').textContent = 'Incorrect code';
                        setTimeout(() => {
                            this.value = '';
                            document.getElementById('passcodeError').textContent = '';
                        }, 1000);
                    }
                });
            }
        });

        /*
         * Reset app to initial state
         */
        function resetApp() {
            // Clear all data
            currentOrder = null;
            currentOrderId = null;
            currentDocumentId = null;
            checkedItems.clear();
            signatureData = null;
            
            // Reset UI
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('orderDetails').classList.add('hidden');
            document.getElementById('orderEntry').classList.remove('hidden');
            document.getElementById('orderNumber').value = '';
            document.getElementById('orderNumber').focus();
            document.getElementById('passcode').value = '';
            document.getElementById('slideToUnlock').classList.remove('hidden');
            document.getElementById('passcodeSection').classList.add('hidden');
            
            // Reset slide position
            document.getElementById('slideTrack').style.transform = 'translateX(0)';
            
            // Hide refresh button
            document.getElementById('refreshButton').style.display = 'none';
        }

        /*
         * Utility functions
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                   date.getDate().toString().padStart(2, '0') + '-' + 
                   date.getFullYear();
        }

       function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            // Parse the UTC date
            const utcDate = new Date(dateString);
            
            // Convert to PST (UTC-8) or PDT (UTC-7) depending on DST
            // For simplicity, we'll use UTC-8 (PST)
            const pstDate = new Date(utcDate.getTime() - (8 * 60 * 60 * 1000));
            
            const month = (pstDate.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = pstDate.getUTCDate().toString().padStart(2, '0');
            const year = pstDate.getUTCFullYear();
            const dateStr = month + '-' + day + '-' + year;
            
            const hours = pstDate.getUTCHours();
            const minutes = pstDate.getUTCMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const timeStr = displayHours.toString().padStart(2, '0') + ':' + 
                           minutes.toString().padStart(2, '0') + ' ' + ampm + ' PST';
            return dateStr + ' ' + timeStr;
        }

        function formatCurrency(cents) {
            if (cents === null || cents === undefined) return '$0.00';
            return '$' + (cents / 100).toFixed(2);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
        }

        /*
         * Refresh order while maintaining checked items
         */
        async function refreshOrder() {
            if (!currentOrder) return;
            
            // Add spinning animation
            document.getElementById('refreshButton').classList.add('spinning');
            
            // Clear terms checkboxes
            document.getElementById('confirmAllPresent').checked = false;
            document.getElementById('confirmGoodCondition').checked = false;
            document.getElementById('acceptTerms').checked = false;
            document.getElementById('authorizedAgent').checked = false;
            document.getElementById('acceptLiability').checked = false;
            
            // Clear signature and name
            clearSignature();
            document.getElementById('signerName').value = '';
            
            // Fetch updated order
            try {
                const response = await fetch(`https://dfi-rentals.booqable.com/api/1/orders/${currentOrder.number}`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to refresh order');
                }
                
                const data = await response.json();
                currentOrder = data.order;
                displayOrder();
                
                // Restore checked items based on line IDs
                document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                    const lineId = checkbox.getAttribute('data-line-id');
                    if (checkedItems.has(lineId)) {
                        checkbox.checked = true;
                    }
                });
                
                updateSignatureSection();
                updateConfirmButton();
                
            } catch (error) {
                alert('Error refreshing order: ' + error.message);
            } finally {
                document.getElementById('refreshButton').classList.remove('spinning');
            }
        }

        /*
         * Handle liability checkbox with modal
         */
        function handleLiabilityCheck() {
            const checkbox = document.getElementById('acceptLiability');
            
            if (checkbox.checked) {
                pendingLiabilityCheck = true;
                checkbox.checked = false;
                document.getElementById('warningModal').style.display = 'flex';
            } else {
                updateConfirmButton();
            }
        }

        /*
         * Close modal
         */
        function closeModal() {
            document.getElementById('warningModal').style.display = 'none';
            pendingLiabilityCheck = false;
            updateConfirmButton();
        }

        /*
         * Confirm liability from modal
         */
        function confirmLiability() {
            document.getElementById('warningModal').style.display = 'none';
            document.getElementById('acceptLiability').checked = true;
            pendingLiabilityCheck = false;
            updateConfirmButton();
        }

        // Allow Enter key to submit
        document.getElementById('orderNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchOrder();
            }
        });
    </script>
</body>
</html>
